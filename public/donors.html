<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Donors Table with Live Filter & Sort Arrow</title>
<link rel="stylesheet" href="styles.css">
<style>

h1 {
  text-align: center;
  margin-bottom: 15px;
}

/* === Filters === */
label {
  margin: 5px 10px 5px 0;
  display: inline-block;
}

input {
  padding: 5px;
}

button { 
  padding: 6px 12px; 
  cursor: pointer; 
  border: none; 
  border-radius: 4px; }

/* === Table Styles === */
table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 20px;
}

th, td {
  border: 1px solid #aaa;
  padding: 8px;
  text-align: left;
}

th {
  cursor: pointer;
  background-color: #f0f0f0;
  user-select: none;
}

th .arrow {
  margin-left: 5px;
  font-size: 0.8em;
}

.delete-btn { background:#dc3545; color:white; }

/* === Mobile Styles === */
@media (max-width: 600px) {
  table, thead, tbody, th, td, tr {
    display: block;
  }

  thead tr {
    display: none; /* hide headers */
  }

  tr {
    margin-bottom: 15px;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 5px;
  }

  td {
    border: none;
    padding: 5px 0;
    position: relative;
    padding-left: 50%;
    text-align: left;
  }

  td::before {
    position: absolute;
    left: 10px;
    top: 5px;
    white-space: nowrap;
    font-weight: bold;
  }

  td:nth-of-type(1)::before { content: "အလှူရှင်အမည်"; }
  td:nth-of-type(2)::before { content: "လိပ်စာ"; }
  td:nth-of-type(3)::before { content: "မြို့"; }
  td:nth-of-type(4)::before { content: "လှူဒါန်းမြှုပ်နှံငွေစုစုပေါင်း"; }
  td:nth-of-type(5)::before { content: "လှူဒါန်းမှုအရေအတွက်"; }
  td:nth-of-type(6)::before { content: "လုပ်ဆောင်ချက်များ"; }

  input {
    width: 100%;
    box-sizing: border-box;
    margin-top: 8px;
  }

  label {
    display: block;
    margin-bottom: 5px;
  }
}
</style>
</head>
<body>
  <nav>
  <a href="/donation.html">အလှူထည့်ရန် </a> | <a href="/donors.html">အလှူရှင်များ </a> | 
  <a href="/admin.html">Admin Panel</a> |
  <button id="logoutBtn" class="logout-btn"  style="float: right;">Logout</button>

<script>
document.getElementById('logoutBtn').addEventListener('click', async () => {
  try {
    await fetch('/api/logout', {
      method: 'POST',
      credentials: 'include' // important to include session cookie
    });
    alert('Logged out!');
    window.location.href = '/login.html'; // redirect after logout
  } catch (err) {
    console.error('Logout failed', err);
  }
});
</script>

</nav>
<h1>အလှူရှင် စာရင်း</h1>

<!-- Filters -->
<label>အမည်ဖြင့်စစ်ထုတ်ရန်: <input type="text" id="filterName"></label>
<label>မြို့ဖြင့်စစ်ထုတ်ရန်: <input type="text" id="filterCity"></label>
<label>အနည်းဆုံးစုစုပေါင်း: <input type="number" id="filterMin"></label>
<label>အများဆုံးစုစုပေါင်း: <input type="number" id="filterMax"></label>

<!-- Table -->
<table>
  <thead>
    <tr>
      <th onclick="sortTable('name')">အလှူရှင်အမည် <span class="arrow" id="arrow-name"></span></th>
      <th onclick="sortTable('city')">မြို့ <span class="arrow" id="arrow-city"></span></th>
      <th>လိပ်စာ</th>
      <th onclick="sortTable('totalDonation')">လှူဒါန်းမြှုပ်နှံငွေစုစုပေါင်း <span class="arrow" id="arrow-totalDonation"></span></th>
      <th>လှူဒါန်းမှုအရေအတွက်</th>
      <th>လုပ်ဆောင်ချက်များ</th>
    </tr>
  </thead>
  <tbody id="donorsTableBody">
    <!-- Rows will be inserted here -->
  </tbody>
</table>

<script>
let donors = [];
let currentSortBy = '';
let currentSortOrder = 'asc';

async function loadDonors() {
  const res = await fetch(`/api/donors`,{
    method: 'GET',
    credentials: 'include'
  });
  const data = await res.json();
  donors = data.donors;
  renderTable();
}

function renderTable() {
  const tbody = document.getElementById('donorsTableBody');
  tbody.innerHTML = '';

  const filterName = document.getElementById('filterName').value.toLowerCase();
  const filterCity = document.getElementById('filterCity').value.toLowerCase();
  const filterMin = parseFloat(document.getElementById('filterMin').value);
  const filterMax = parseFloat(document.getElementById('filterMax').value);

  let filtered = donors.filter(donor => {
    const total = donor.totalDonation || 0;
    return (
      (!filterName || donor.name.toLowerCase().includes(filterName)) &&
      (!filterCity || donor.city.toLowerCase().includes(filterCity)) &&
      (isNaN(filterMin) || total >= filterMin) &&
      (isNaN(filterMax) || total <= filterMax)
    );
  });

  // Sort if needed
  if (currentSortBy) {
    filtered.sort((a, b) => {
      let valA = a[currentSortBy];
      let valB = b[currentSortBy];

      if (typeof valA === 'string') valA = valA.toLowerCase();
      if (typeof valB === 'string') valB = valB.toLowerCase();

      if (valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
      if (valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
      return 0;
    });
  }

  // Update arrow indicators
  ['name','city','totalDonation'].forEach(field => {
    const el = document.getElementById(`arrow-${field}`);
    if (currentSortBy === field) {
      el.textContent = currentSortOrder === 'asc' ? '↑' : '↓';
    } else {
      el.textContent = '';
    }
  });

  filtered.forEach(donor => {
  const tr = document.createElement('tr');
  tr.innerHTML = `
      <td><a href="donor.html?donorId=${donor._id}">${donor.name}</a></td>
      <td>${donor.city}</td>
      <td>${donor.address}</td>
      <td>${donor.totalDonation || 0}</td>
      <td>${donor.donations.length}</td>
      <td>
        <button onclick="deleteDonor('${donor._id}')" class="delete-btn">ဖျက်မည်</button>
      </td>
  `;
  tbody.appendChild(tr);
});
}

// Live filtering
document.getElementById('filterName').addEventListener('input', renderTable);
document.getElementById('filterCity').addEventListener('input', renderTable);
document.getElementById('filterMin').addEventListener('input', renderTable);
document.getElementById('filterMax').addEventListener('input', renderTable);

// Sorting
function sortTable(field) {
  if (currentSortBy === field) {
    currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortBy = field;
    currentSortOrder = 'asc';
  }
  renderTable();
}

async function deleteDonor(donorId) {
  const confirmDelete = confirm("Are you sure you want to delete this donor and all their donations?");
  if (!confirmDelete) return;

  const res = await fetch(`/api/donors/${donorId}`, { method: 'DELETE' });
  const data = await res.json();

  if (data.success) {
    alert("Donor deleted!");
    // Remove deleted donor from local array and re-render
    donors = donors.filter(d => d._id !== donorId);
    renderTable();
  } else {
    alert("Error deleting donor: " + data.message);
  }
}
// Initial load
loadDonors();
</script>
</body>
</html>
