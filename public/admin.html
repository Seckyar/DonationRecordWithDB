<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<link rel="stylesheet" href="styles.css">
<style>
  h1 { color:#333; }
  input, select { margin: 5px 0; padding: 8px; max-width: 300px; }
  button { padding: 6px 12px; cursor: pointer; border: none; border-radius: 4px; }
  #msg { margin-top: 10px; }
  .success { color: green; }
  .error { color: red; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; background:white; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background:#f1f1f1; }
  .edit-btn { background:#ffc107; color:black; }
  .delete-btn { background:#dc3545; color:white; }
  .save-btn { background:#28a745; color:white; }

  @media (max-width: 600px) {
  table, thead, tbody, th, td, tr {
    display: block;
  }

  thead tr {
    display: none; /* hide table header */
  }

  tr {
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 10px;
    background: #fff;
  }

  td {
    border: none;
    padding: 5px 0;
    position: relative;
    padding-left: 50%;
    text-align: left;
  }

  td::before {
    position: absolute;
    left: 10px;
    top: 5px;
    white-space: nowrap;
    font-weight: bold;
  }

  td:nth-of-type(1)::before { content: "Username"; }
  td:nth-of-type(2)::before { content: "Role"; }
  td:nth-of-type(3)::before { content: "Actions"; }

  input, select, button {
    box-sizing: border-box;
    margin-bottom: 10px;
  }
}
</style>
</head>
<body>
  <nav>
  <a href="/donation.html">Donate</a> | <a href="/donors.html">All Donors</a> | 
  <a href="/admin.html">Admin Panel</a> |
  <button id="logoutBtn" class="logout-btn"  style="float: right;">Logout</button>

<script>
document.getElementById('logoutBtn').addEventListener('click', async () => {
  try {
    await fetch('/api/logout', {
      method: 'POST',
      credentials: 'include' // important to include session cookie
    });
    alert('Logged out!');
    window.location.href = '/login.html'; // redirect after logout
  } catch (err) {
    console.error('Logout failed', err);
  }
});
</script>

</nav>
  <h1>Admin Panel</h1>

  <h3>Create New Account</h3>
  <label>Username</label><br>
  <input type="text" id="username" placeholder="Enter username"><br>

  <label>Password</label><br>
  <input type="password" id="password" placeholder="Enter password"><br>

  <label>Role</label><br>
  <select id="role">
    <option value="user">User</option>
    <option value="admin">Admin</option>
  </select><br>

  <button onclick="createAccount()">Create Account</button>
  <p id="msg"></p>

  <hr>

  <h3>All Accounts</h3>
  <table id="accountsTable">
    <thead>
      <tr>
        <th>Username</th>
        <th>Role</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>



  <script>
  async function createAccount() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    const msg = document.getElementById('msg');

    const res = await fetch('/api/register', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ username, password, role })
    });

    
    const data = await res.json();
    msg.textContent = data.message;
    msg.className = data.success ? 'success' : 'error';
    if (data.success) loadAccounts();
  }

  async function loadAccounts() {
    let accounts = [];
    const res = await fetch('/api/accounts');
     if (!res.ok) {
      // for example, 401 Unauthorized
      if (res.status === 401) {
        alert('You are not logged in. Redirecting to login page.');
        window.location.href = '/login.html';
      } else {
        alert('Error: ' + res.status);
      }
    } else {
      accounts = await res.json();
    }
    
    const tbody = document.querySelector('#accountsTable tbody');
    tbody.innerHTML = '';
    accounts.forEach(acc => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="${acc.username}" data-id="${acc._id}" class="username-input" disabled></td>
        <td>
          <select data-id="${acc._id}" class="role-select" disabled>
            <option value="user" ${acc.role === 'user' ? 'selected' : ''}>User</option>
            <option value="admin" ${acc.role === 'admin' ? 'selected' : ''}>Admin</option>
          </select>
        </td>
        <td>
          <button class="edit-btn" onclick="enableEdit('${acc._id}')">Edit</button>
          <button class="save-btn" style="display:none;" onclick="saveAccount('${acc._id}')">Save</button>
          <button class="delete-btn" onclick="deleteAccount('${acc._id}', '${acc.username}')">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function enableEdit(id) {
    document.querySelector(`input[data-id="${id}"]`).disabled = false;
    document.querySelector(`select[data-id="${id}"]`).disabled = false;
    document.querySelector(`button[onclick="enableEdit('${id}')"]`).style.display = 'none';
    document.querySelector(`button[onclick="saveAccount('${id}')"]`).style.display = 'inline-block';
  }

  async function saveAccount(id) {
    const username = document.querySelector(`input[data-id="${id}"]`).value;
    const role = document.querySelector(`select[data-id="${id}"]`).value;

    const res = await fetch(`/api/accounts/${id}`, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ username, role })
    });

    const data = await res.json();
    alert(data.message);
    loadAccounts();
  }

  async function deleteAccount(id, username) {
    if (!confirm(`Are you sure you want to delete "${username}"?`)) return;

    const res = await fetch(`/api/accounts/${id}`, { method: 'DELETE' });
    const data = await res.json();
    alert(data.message);
    loadAccounts();
  }

  loadAccounts();
  </script>
</body>
</html>
