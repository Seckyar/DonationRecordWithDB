<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Donation</title>
<link rel="stylesheet" href="styles.css">
<style>

  /* General */


/* Responsive styles for small screens */
@media (max-width: 600px) {

  table, thead, tbody, th, td, tr {
    display: block;
    width: 100%;
  }

  thead tr {
    display: none;
  }

  tr {
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 10px;
    background: #fff;
  }

  td {
    border: none;
    padding: 5px 0;
    position: relative;
    padding-left: 50%;
    text-align: left;
  }

  td::before {
    position: absolute;
    left: 10px;
    top: 5px;
    font-weight: bold;
    white-space: nowrap;
  }

  td:nth-of-type(1)::before { content: "အလှူရှင်အမည်"; }
  td:nth-of-type(2)::before { content: "လိပ်စာ"; }
  td:nth-of-type(3)::before { content: "မြို့"; }
  td:nth-of-type(4)::before { content: "လှူဒါန်းမြှုပ်နှံငွေစုစုပေါင်း"; }
  td:nth-of-type(5)::before { content: "လှူဒါန်းမှုအရေအတွက်"; }

  
  input {
    width: 100%;
    box-sizing: border-box;
    margin: 6px 0 12px 0;
  }

  label {
    display: block;
    margin-bottom: 5px;
  }
}

</style>
</head>
<body>
<nav>
  <a href="/donation.html">အလှူထည့်ရန် </a> | <a href="/donors.html">အလှူရှင်များ </a> | 
  <a href="/admin.html">Admin Panel</a> |
  <button id="logoutBtn" class="logout-btn"  style="float: right;">Logout</button>

<script>
document.getElementById('logoutBtn').addEventListener('click', async () => {
  try {
    await fetch('/api/logout', {
      method: 'POST',
      credentials: 'include' // important to include session cookie
    });
    alert('Logged out!');
    window.location.href = '/login.html'; // redirect after logout
  } catch (err) {
    console.error('Logout failed', err);
  }
});
</script>

</nav>
<h1>သထုံမြို သုဝဏ္ဏဘူမိ<br>ပရိယတ္တိ သာသနဟိတအသင်း</h1>
  <h3 id="total">Loading...</h3>

  <script>
    async function fetchTotal() {
      try {
        const response = await fetch('/api/donations/total');
        const data = await response.json();
        if (data.success) {
          document.getElementById('total').textContent =
            'ငွေပင်ငွေရင်းစုစုပေါင်း: ' + data.totalDonationAll + ' ကျပ်';
        } else {
          document.getElementById('total').textContent = 'Error fetching total.';
        }
      } catch (err) {
        document.getElementById('total').textContent = 'Server error.';
      }
    }

    // Fetch total when page loads
    fetchTotal();
  </script>
<h2>အလှူရှင် ရှာရန်</h2>
<input type="text" id="searchDonor" style="margin-top: 6px;" placeholder="အမည် သို့မဟုတ် မြို့ဖြင့် ရှာရန်">

<table id="donorsTable">
  <thead>
    <tr>
      <th>အလှူရှင်အမည်</th>
      <th>လိပ်စာ</th>
      <th>မြို့</th>
      <th>လှူဒါန်းမြှုပ်နှံငွေစုစုပေါင်း</th>
      <th>လှူဒါန်းမှုအရေအတွက်</th>
    </tr>
  </thead>
  <tbody id="donorsTableBody"></tbody>
</table>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('searchDonor');
  const table = document.getElementById('donorsTable');
  const tbody = document.getElementById('donorsTableBody');
  let donors = [];

  // Load donors from server
  async function loadDonors() {
    try {
      const res = await fetch('/api/donors');
      const data = await res.json();
      if (data.success) {
        donors = data.donors;
      } else {
        alert('Failed to load donors. Please log in.');
        window.location.href = '/login.html';
      }
    } catch (err) {
      console.error(err);
      alert('Error fetching donors.');
    }
  }

  function renderTable() {
    const query = searchInput.value.trim().toLowerCase();
    if (!query) {
      table.style.display = 'none';
      tbody.innerHTML = '';
      return;
    }

    const filtered = donors.filter(d => 
      d.name.toLowerCase().includes(query) || d.city.toLowerCase().includes(query)
    );

    tbody.innerHTML = '';
    filtered.forEach(donor => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="donor.html?donorId=${donor._id}">${donor.name}</a></td>
        <td>${donor.address}</td>
        <td>${donor.city}</td>
        <td>${donor.totalDonation || 0}</td>
        <td>${donor.donations.length}</td>
      `;
      tbody.appendChild(tr);
    });

    table.style.display = filtered.length ? 'table' : 'none';
  }

  searchInput.addEventListener('input', renderTable);
  loadDonors();
});
</script>
<h1>အလှူရှင် အသစ်ထည့်ရန်</h1>
<form id="donationForm">
  အလှူရှင်အမည်: <input type="text" id="name" required><br>
  လိပ်စာ: <input type="text" id="address" required><br>
  မြို့: <input type="text" id="city" required><br>
  လှူဒါန်းမြှုပ်နှံငွေ: <input type="number" id="amount" required><br>
  ရက်စွဲ: <input type="date" id="date" required><br>
  <button type="submit" style="margin-top: 10px;" class="save-btn">ထည့်မည်</button>
</form>

<pre id="response"></pre>

<script>
const form = document.getElementById('donationForm');
const responseEl = document.getElementById('response');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = {
    name: document.getElementById('name').value,
    address: document.getElementById('address').value,
    city: document.getElementById('city').value,
    amount: parseFloat(document.getElementById('amount').value),
    date: document.getElementById('date').value
  };

  const res = await fetch('/api/donations', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    credentials: 'include',
    body: JSON.stringify(data)
  });
  if (!res.ok) {
      // for example, 401 Unauthorized
      if (res.status === 401) {
        alert('You are not logged in. Redirecting to login page.');
        window.location.href = '/login.html';
      } else {
        alert('Error: ' + res.status);
      }
    } else {
  alert('Donation added successfully!');
  location.reload();
}
});

</script>
</body>
</html>
